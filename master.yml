---

- name: Check if database is already initialized
  stat:
    path: '/var/lib/pgsql/12/data/PG_VERSION'
  register: init_status

- name: Initialize the PostgreSQL database
  shell: "/usr/pgsql-12/bin/postgresql-12-setup initdb"
  when: inventory_hostname in groups['dbmaster'] and init_status.stat.exists == False

- name: Update postgresql.conf file
  blockinfile:
    path: /var/lib/pgsql/12/data/postgresql.conf
    block: |
      #############################
      listen_addresses = '*'
      shared_preload_libraries = 'repmgr'
      wal_level = replica
      archive_mode = on
      max_wal_senders = 10
      hot_standby = on
      archive_command = 'cp -i %p /var/lib/pgsql/12/data/archive/%f'
      #############################
  register: postgresql_config

- name: Enable replication user to login
  become: true
  become_user: postgres
  blockinfile:
    path: /var/lib/pgsql/12/data/pg_hba.conf
    block: |
      {% for host in groups['db_hosts'] %}
      host    replication     repmgr     {{ hostvars[host]['ansible_facts']['eth1']['ipv4']['address'] }}/32    trust
      host    repmgr          repmgr     {{ hostvars[host]['ansible_facts']['eth1']['ipv4']['address'] }}/32    trust
      {% endfor %}
  register: pghba_config

- name: Create archive directory
  file:
    path: /var/lib/pgsql/12/data/archive'
    state: directory
    owner: postgres
    group: postgres
    mode: 0700

- name: Start and enable PostgreSQL service on boot
  systemd:
    name: postgresql-12.service
    state: started
    enabled: yes

- name: Restart database if config changed
  command: echo ""
  when: postgresql_config.changed or pghba_config.changed
  notify: Restart database

- name: Flush handler
  meta: flush_handlers

- name: Create repmgr user in PostgreSQL
  postgresql_user:
    name: repmgr
    role_attr_flags: REPLICATION,CREATEDB,CREATEROLE,SUPERUSER
  become: true
  become_user: postgres

- name: Create repmgr database owner repmgr in PostgreSQL
  postgresql_db:
    name: repmgr
    owner: repmgr
    state: present
  become: true
  become_user: postgres

- name: Alter repmgr user and set search path
  command: psql -c 'ALTER USER repmgr SET search_path TO repmgr, public;'
  become: true
  become_user: postgres

- name: Check if repmgr is started
  stat:
    path: '/tmp/repmgrd.pid'
  register: repmgr_status

- name: Register Master in repmgr
  command: /usr/pgsql-12/bin/repmgr primary register
  become: true
  become_user: postgres
  when: repmgr_status.stat.exists == False

- name: Start repmgr daemon
  command: /usr/pgsql-12/bin/repmgr daemon start
  become: true
  become_user: postgres
  when: repmgr_status.stat.exists == False

- name: Check repmgr daemon status
  command: /usr/pgsql-12/bin/repmgr daemon status
  become: true
  become_user: postgres
  register: repmgr_status
  when: repmgr_status.stat.exists == True

- debug:
    var: repmgr_status.stdout
